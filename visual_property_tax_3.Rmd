---
title: "Data Visualization"
author: "Fernando Garcia - Drazzel Feliu"
date: "8/25/2020"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(lubridate)
library(ggmap)
library(tidycensus)
library(mapview)
library(sf)
library(leaflet)
library(viridis)
library(maps)
library(htmlwidgets)
library(htmltools)
library(tigris)
library(reshape2)
library(ggrepel)
library(ggmap)
library(snakecase)

rm(list = ls())
```

```{r, warning=FALSE, error=FALSE}

gent <- readRDS("gent.RDS")
```

Neighborhood Polygons:

```{r, warning=FALSE, error=FALSE}
community <- read_sf("geo_export_72cf3d72-fa82-4448-a382-c9dd6dcb4fd2.shp")

community <- st_transform(
  community,
  4326
)
```

Leaflet Options and Colors:

```{r Leaflet Options - Community Areas}
neigh_h_lights <- highlightOptions(
  weight = 4.5,
  color = "#ffffff",
  fillOpacity = .5,
  bringToFront = TRUE
)

neigh_l_options <- labelOptions(
  style = list("font-weight" = "normal", padding = "3px 8px"),
  textsize = "15px",
  direction = "auto"
)

neigh_labels <- sprintf(
  paste0(
    "<strong>Name: </strong>%s<br/>"
  ),
  to_title_case(community$community)
) %>%
  lapply(HTML)
```

```{r Leaflet Options - Census Tracts}
tract_h_lights <- highlightOptions(
  weight = 4.5,
  color = "#ffffff",
  fillOpacity = .5,
  bringToFront = TRUE
)

tract_l_options <- labelOptions(
  style = list("font-weight" = "normal", padding = "3px 8px"),
  textsize = "15px",
  direction = "auto"
)

tract_labels <- sprintf(
  paste0(
    "<strong>Name: </strong>%s<br/>",
    "<strong>Median Income 2013: </strong>%g<br/>",
    "<strong>Median Income 2018: </strong>%g<br/>",
    "<strong>Change in Median Income: </strong>%g%%<br/>",
    "<strong>Median Housing Value 2013: </strong>%g<br/>",
    "<strong>Median Housing Value 2013: </strong>%g<br/>",
    "<strong>Change in Median Housing Value: </strong>%g%%<br/>",
    "<strong>Race in 2013</strong><br/><strong>White: </strong>%g%%,<br/><strong>Black: </strong>%g%%<br/><strong>Latino: </strong>%g%%"
  ),
  gent$NAME,
  gent$household_income_13,
  gent$household_income_18,
  round(gent$increase_income,2),
  gent$value_13,
  gent$value_18,
  round(gent$increase_value,2),
  gent$share_white_13*100,
  gent$share_black_13*100,
  gent$share_latino_13*100
) %>%
  lapply(HTML)
```

#Different Maps with increase in property values as example

Using ggplot:

```{r, warning=FALSE, error=FALSE}
ggplot() +
  geom_sf(gent,
    mapping = aes(
      fill = increase_value,
      color = increase_value
    ),
    inherit.aes = F,
    alpha = .99
  ) +
  scale_fill_viridis() +
  scale_color_viridis() +
  theme_minimal() +
  ggtitle("Percentage increase in property values between 2018 and 2013", )
```

```{r, warning=FALSE, error=FALSE}
ggplot() +
  geom_sf(gent,
    mapping = aes(
      fill = share_black_13,
      color = share_black_13
    ),
    inherit.aes = F,
    alpha = .99
  ) +
  scale_fill_viridis() +
  scale_color_viridis() +
  theme_minimal() +
  ggtitle("Share of black population by tracts in 2013", )
```

```{r, warning=FALSE, error=FALSE}
ggplot() +
  geom_sf(gent,
    mapping = aes(
      fill = share_black_18,
      color = share_black_18
    ),
    inherit.aes = F,
    alpha = .99
  ) +
  scale_fill_viridis() +
  scale_color_viridis() +
  theme_minimal() +
  ggtitle("Share of black population by tracts in 2018", )
```

```{r, warning=FALSE, error=FALSE}
ggplot() +
  geom_sf(gent,
    mapping = aes(
      fill = share_latino_18,
      color = share_latino_18
    ),
    inherit.aes = F,
    alpha = .99
  ) +
  scale_fill_viridis() +
  scale_color_viridis() +
  theme_minimal() +
  ggtitle("Share of latino population by tracts in 2018", )
```

Visualizations begin

```{r, warning=FALSE, error=FALSE}

color_200k <- colorNumeric(
  palette = c("red","white","green"),
  domain = c(-max(gent$increase_value,na.rm = T),max(gent$increase_value,na.rm = T)))
)


c(-max(gent$increase_value),max(gent$increase_value))
```

Map #3:


```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    data = st_geometry(community),
    color = "black",
    fillColor = "gray",
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    fillOpacity = .1,
    weight = 3,
    group = "Community Areas"
  ) %>% 
  addPolygons(
    data = st_geometry(gent),
    color = "black",
    fillColor = color_200k(gent$increase_value),
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    weight = 1,
    fillOpacity = .5,
    smoothFactor = .2,
    group = "Tracts"
  ) %>%
  addLegend(
    title = "Percentage change housing values<br> between 2018 and 2013",
    pal = color_200k,
    values = gent$increase_value,
    position = "topright"
  ) %>% 
  addLayersControl(
    overlayGroups = c("Tracts", "Community Areas"),
    position = "bottomright"
  )
```


Continuous third definition of gentrification: 

```{r, warning=FALSE, error=FALSE}

color_200k <- colorNumeric(
  palette = c("white", "blue"),
  domain = gent$gentri_3
)
```

```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(gent),
    color = "black",
    fillColor = color_200k(gent$gentri_3),
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    group = "Gentrification By Education"
  ) %>%
  addPolygons(
    data = st_geometry(community),
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    group = "Community Areas"
  ) %>%
  addLegend(
    title = "Gentrified tracts between 2018 and 2013",
    pal = color_200k,
    values = gent$gentri_3,
    position = "topright"
  ) %>%
  addLayersControl(
    overlayGroups = c("Gentrification By Education", "Community Areas"),
    position = "bottomright"
  )
```



These are the tracts that would be gentrified according to definition 3:

```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_3 == 1)),
    color = "black",
    fillColor = color_200k(gent$gentri_3),
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  )  %>%
  addPolygons(
    data = st_geometry(community),
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    group = "Community Areas"
  ) %>%
  addLayersControl(
    overlayGroups = c("Gentrification By Education", "Community Areas"),
    position = "bottomright"
  )
```

These are the tracts that are gentrified according to definition 4:

```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_4 == 1)),
    color = "black",
    fillColor = color_200k(gent$increase_income),
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  ) %>%
  addPolygons(
    data = st_geometry(community),
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    group = "Community Areas"
  ) %>%
  addLayersControl(
    overlayGroups = c("Gentrification By Education", "Community Areas"),
    position = "bottomright"
  )
```

Gentrified tracts according to definitions 3 (blue) and 4 (black) with tracts that coincide in red: 

```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_3 == 1)),
    color = "blue",
    fillColor = "blue",
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  ) %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_4 == 1)),
    color = "black",
    fillColor = color_200k(gent$increase_income),
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  ) %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$common_gent_3_4 == 1)),
    color = "black",
    fillColor = "red",
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  )  %>%
  addPolygons(
    data = st_geometry(community),
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    group = "Community Areas"
  ) %>%
  addLayersControl(
    overlayGroups = c("Gentrification By Education", "Community Areas"),
    position = "bottomright"
  )
```

```{r}

leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_3 == 1 & increase_value >15)),
    color = "black",
    fillColor = "red",
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  )  %>%
  addPolygons(
    data = st_geometry(gent %>% filter(gent$one_gentri_4 == 1 & increase_value >15)),
    color = "black",
    fillColor = "blue",
    weight = 2.5,
    fillOpacity = .3,
    smoothFactor = .2,
    popup = tract_labels,
    popupOptions = tract_l_options,
    highlightOptions = tract_h_lights,
    group = "Gentrification By Education"
  ) %>%
  addPolygons(
    data = st_geometry(community),
    popup = neigh_labels,
    popupOptions = neigh_l_options,
    highlightOptions = neigh_h_lights,
    group = "Community Areas"
  ) %>%
  addLayersControl(
    overlayGroups = c("Gentrification By Education", "Community Areas"),
    position = "bottomright"
  )
```
