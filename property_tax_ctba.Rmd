---
title: "Property Tax Exemption"
author: "Fernando Garcia - Drazzel Feliu"
date: "8/11/2020"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(lubridate)
library(ggmap)
library(tidycensus)
library(mapview)
library(sf)
library(leaflet)
library(viridis)
library(maps)
library(htmlwidgets)
library(htmltools)
library(tigris)
library(reshape2)
library(ggrepel)
library(ggmap)
```

Below, I pull the median property value for year 2018 by tract:  

```{r, warning=FALSE, error=FALSE}
census_data <- get_acs(
  geography = "tract",
  variables = c(
    median_value = "B25077_001"
  ),
  state = "IL",
  county = "Cook County",
  year = 2018,
  geometry = TRUE
)
```

```{r, warning=FALSE, error=FALSE}
census_data <- census_data %>%
  select(GEOID, NAME, estimate, geometry)

census_data <- census_data %>%
  rename(value_18 = estimate)
```


Below, I pull the median property value for year 2013 by tract:  


```{r, warning=FALSE, error=FALSE}
census_data_13 <- get_acs(
  geography = "tract",
  variables = c(
    median_value = "B25077_001"
  ),
  state = "IL",
  county = "Cook County",
  year = 2013,
  geometry = TRUE
)
```

```{r, warning=FALSE, error=FALSE}
census_data_13 <- census_data_13 %>%
  select(GEOID, NAME, estimate, geometry)

census_data_13 <- census_data_13 %>%
  rename(value_13 = estimate)
```

```{r, warning=FALSE, error=FALSE}
st_geometry(census_data_13) <- NULL

census <- census_data %>%
  left_join(census_data_13, by = c("GEOID", "NAME"))
```

```{r, warning=FALSE, error=FALSE}
census <- census %>%
  mutate(increase_value = (value_18 / value_13 - 1) * 100)
```

```{r, warning=FALSE, error=FALSE}
mapview(census, zcol = "increase_value")
```

```{r, warning=FALSE, error=FALSE}
census %>%
  arrange(desc(increase_value)) %>%
  head(5)
```


#Restricting to City of Chicago

```{r, warning=FALSE, error=FALSE}

cityboundary <- read_sf("geo_export_72cf3d72-fa82-4448-a382-c9dd6dcb4fd2.shp")

cityboundary <- st_union(cityboundary)

cityboundary <- st_transform(cityboundary,
                             4326)

```

```{r, warning=FALSE, error=FALSE}

class(census)

class(cityboundary)

cityboundary <- cityboundary

census <- census

chicago_only <- st_join(census, cityboundary)

```


```{r}

#calabels <- sprintf(
  #paste0("<strong>%g%%</strong> of single filers earning over $200K in Illinois reside in <strong>%s.</strong><br/>"),
  #round(test$x_200_k_or_more_as_pct, 2),
  #test$county
#) %>%
  #lapply(HTML)

#callaboptions <- labelOptions(
  #style = list(
 #   "font-weight" = "normal",
  #  padding = "3px 8px"
  #),
  #textsize = "15px",
  #direction = "auto"
#)
```


Colors:

```{r, warning=FALSE, error=FALSE}

color_200k <- colorNumeric(
  palette = c("white", "blue"),
  domain = chicago_only$increase_value
)
```

Map:


```{r}

map <- leaflet(options = leafletOptions(zoomSnap = 0.1)) %>%
  addTiles() %>%
  addPolygons(
    data = st_geometry(chicago_only),
    color = "black",
    fillColor = color_200k(chicago_only$increase_value),
    popup = calabels,
    popupOptions = callaboptions,
    weight = 2.5,
    fillOpacity = .55,
    smoothFactor = .2
  ) %>%
  addLegend(
    title = "Percentage increase of housing values between 2018 and 2013",
    pal = color_200k,
    values = test$increase_value,
    position = "topright"
  )
saveWidget(map, "downstate_200k.html")

webshot("downstate_200k.html",
  file = "downstate_200k.png",
  cliprect = "viewport"
)
```
